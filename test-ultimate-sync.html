<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ Ultimate Sync - Teste Completo</title>
    <!-- Google Sign-In Meta Tag -->
    <meta name="google-signin-client_id" content="507473876859-o0urtsgjnetchqkqcf16ium53ejp1tts.apps.googleusercontent.com">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #f39c12;
        }

        .status-value {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .status-ok {
            color: #2ecc71;
        }

        .status-error {
            color: #e74c3c;
        }

        .status-warning {
            color: #f39c12;
        }

        .test-section {
            margin: 30px 0;
            padding: 25px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border-left: 4px solid #3498db;
        }

        .test-section h3 {
            margin-bottom: 15px;
            color: #3498db;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .test-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .test-btn.google {
            background: linear-gradient(135deg, #4285f4, #34a853);
        }

        .test-btn.sync {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .test-btn.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .logs {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
        }

        .log-info {
            background: rgba(52, 152, 219, 0.2);
            border-left: 3px solid #3498db;
        }

        .log-success {
            background: rgba(46, 204, 113, 0.2);
            border-left: 3px solid #2ecc71;
        }

        .log-error {
            background: rgba(231, 76, 60, 0.2);
            border-left: 3px solid #e74c3c;
        }

        .log-warning {
            background: rgba(243, 156, 18, 0.2);
            border-left: 3px solid #f39c12;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            font-size: 12px;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            h1 {
                font-size: 2rem;
            }

            .status-grid {
                grid-template-columns: 1fr;
            }

            .button-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Ultimate Sync - Teste Completo</h1>
        
        <div id="statusDisplay" class="status-grid">
            <!-- Status serÃ¡ preenchido via JavaScript -->
        </div>

        <div class="test-section">
            <h3>ğŸ” Testes de AutenticaÃ§Ã£o Google</h3>
            <div class="button-grid">
                <button class="test-btn google" onclick="testGoogleSignIn()">
                    ğŸ” Testar Login Google
                </button>
                <button class="test-btn google" onclick="testGoogleSignOut()">
                    ğŸšª Testar Logout Google
                </button>
                <button class="test-btn" onclick="checkGoogleStatus()">
                    ğŸ“Š Status do Google Auth
                </button>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ”„ Testes de SincronizaÃ§Ã£o por CÃ³digo</h3>
            <div class="button-grid">
                <button class="test-btn sync" onclick="testGenerateCode()">
                    ğŸ“¤ Gerar CÃ³digo de Teste
                </button>
                <button class="test-btn sync" onclick="testUseFakeCode()">
                    ğŸ“¥ Testar CÃ³digo Falso
                </button>
                <button class="test-btn" onclick="showSyncModal()">
                    ğŸ”„ Abrir Modal de Sync
                </button>
                <button class="test-btn" onclick="testCodeValidation()">
                    âœ… Testar ValidaÃ§Ã£o
                </button>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“± Testes de Dispositivo</h3>
            <div class="button-grid">
                <button class="test-btn" onclick="testDeviceDetection()">
                    ğŸ“± Detectar Dispositivo
                </button>
                <button class="test-btn" onclick="testLocalStorage()">
                    ğŸ’¾ Testar LocalStorage
                </button>
                <button class="test-btn" onclick="testCookies()">
                    ğŸª Testar Cookies
                </button>
                <button class="test-btn" onclick="testBrowserFeatures()">
                    ğŸŒ Recursos do Navegador
                </button>
            </div>
        </div>

        <div class="test-section">
            <h3>âš ï¸ Testes de Erro</h3>
            <div class="button-grid">
                <button class="test-btn danger" onclick="testNetworkError()">
                    ğŸŒ Simular Erro de Rede
                </button>
                <button class="test-btn danger" onclick="testStorageError()">
                    ğŸ’¾ Simular Erro de Storage
                </button>
                <button class="test-btn danger" onclick="testInvalidCode()">
                    ğŸ”„ CÃ³digo InvÃ¡lido
                </button>
                <button class="test-btn" onclick="testErrorRecovery()">
                    ğŸ”§ RecuperaÃ§Ã£o de Erro
                </button>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š Logs e DiagnÃ³sticos</h3>
            <div class="button-grid">
                <button class="test-btn" onclick="clearLogs()">
                    ğŸ—‘ï¸ Limpar Logs
                </button>
                <button class="test-btn" onclick="exportLogs()">
                    ğŸ“‹ Exportar Logs
                </button>
                <button class="test-btn" onclick="refreshStatus()">
                    ğŸ”„ Atualizar Status
                </button>
                <button class="test-btn" onclick="runFullDiagnostic()">
                    ğŸ” DiagnÃ³stico Completo
                </button>
            </div>
            
            <div id="logs" class="logs">
                <div class="log-entry log-info">ğŸš€ Sistema iniciado - aguardando testes...</div>
            </div>
        </div>

        <div class="footer">
            <p>
                <strong>Ultimate Sync Solution</strong> - SoluÃ§Ã£o definitiva para sincronizaÃ§Ã£o cross-device<br>
                âœ… Google Auth + ğŸ”„ CÃ³digos de 6 dÃ­gitos + ğŸ’¾ Storage local + ğŸ”§ RecuperaÃ§Ã£o de erros
            </p>
        </div>
    </div>

    <!-- Scripts necessÃ¡rios -->
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script>
        // Dados mockados para teste
        const data = {
            level: 15,
            xp: 2450,
            streak: 7,
            quests: [
                { id: 'checkin', name: 'Check-in DiÃ¡rio', completed: true, xp: 50 },
                { id: 'spoils', name: 'EspÃ³lios', completed: false, xp: 100 },
                { id: 'expedition', name: 'ExpediÃ§Ã£o', completed: true, xp: 150 }
            ]
        };

        function saveData() {
            localStorage.setItem('wydQuestData', JSON.stringify(data));
        }

        function showAchievement(message) {
            log(message, 'info');
        }

        function updateUI() {
            log('ğŸ”„ UI atualizada', 'info');
        }
    </script>
    <script src="ultimate-sync.js"></script>
    
    <script>
        let logCount = 0;

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
            
            logCount++;
            if (logCount > 100) {
                logs.removeChild(logs.firstChild);
                logCount--;
            }
            
            console.log(`[${timestamp}] ${message}`);
        }

        function updateStatus() {
            const statusDisplay = document.getElementById('statusDisplay');
            const status = ultimateSync.getStatus();
            const isSecure = location.protocol === 'https:';
            const hasGAPI = !!window.gapi;
            
            statusDisplay.innerHTML = `
                <div class="status-card">
                    <div class="status-title">ğŸ”’ SeguranÃ§a</div>
                    <div class="status-value ${isSecure ? 'status-ok' : 'status-error'}">
                        HTTPS: ${isSecure ? 'âœ… Ativo' : 'âŒ Inativo'}
                    </div>
                    <div class="status-value">
                        URL: ${location.href}
                    </div>
                </div>

                <div class="status-card">
                    <div class="status-title">ğŸ”— Google APIs</div>
                    <div class="status-value ${hasGAPI ? 'status-ok' : 'status-error'}">
                        GAPI: ${hasGAPI ? 'âœ… Carregado' : 'âŒ NÃ£o carregado'}
                    </div>
                    <div class="status-value ${status.googleAuthAvailable ? 'status-ok' : 'status-warning'}">
                        Auth2: ${status.googleAuthAvailable ? 'âœ… DisponÃ­vel' : 'âš ï¸ IndisponÃ­vel'}
                    </div>
                </div>

                <div class="status-card">
                    <div class="status-title">ğŸ“± Dispositivo</div>
                    <div class="status-value status-ok">
                        ID: ${status.deviceId}
                    </div>
                    <div class="status-value status-ok">
                        Nome: ${status.deviceName}
                    </div>
                </div>

                <div class="status-card">
                    <div class="status-title">ğŸ”„ SincronizaÃ§Ã£o</div>
                    <div class="status-value ${status.syncMethod === 'google' ? 'status-ok' : 'status-warning'}">
                        MÃ©todo: ${status.syncMethod === 'google' ? 'ğŸ” Google' : 'ğŸ”„ CÃ³digo'}
                    </div>
                    <div class="status-value ${status.isGoogleSignedIn ? 'status-ok' : 'status-warning'}">
                        Google Login: ${status.isGoogleSignedIn ? 'âœ… Ativo' : 'âŒ Inativo'}
                    </div>
                </div>

                <div class="status-card">
                    <div class="status-title">ğŸ’¾ Storage</div>
                    <div class="status-value ${localStorage ? 'status-ok' : 'status-error'}">
                        LocalStorage: ${localStorage ? 'âœ… DisponÃ­vel' : 'âŒ IndisponÃ­vel'}
                    </div>
                    <div class="status-value ${navigator.cookieEnabled ? 'status-ok' : 'status-error'}">
                        Cookies: ${navigator.cookieEnabled ? 'âœ… Habilitados' : 'âŒ Desabilitados'}
                    </div>
                </div>

                <div class="status-card">
                    <div class="status-title">ğŸŒ Navegador</div>
                    <div class="status-value status-ok">
                        User Agent: ${navigator.userAgent.substring(0, 50)}...
                    </div>
                    <div class="status-value status-ok">
                        Platform: ${navigator.platform}
                    </div>
                </div>
            `;
        }

        // Testes de AutenticaÃ§Ã£o Google
        async function testGoogleSignIn() {
            log('ğŸ” Testando login Google...', 'info');
            try {
                await ultimateSync.signInGoogle();
                log('âœ… Teste de login Google concluÃ­do', 'success');
            } catch (error) {
                log(`âŒ Erro no teste de login: ${error.message}`, 'error');
            }
        }

        async function testGoogleSignOut() {
            log('ğŸšª Testando logout Google...', 'info');
            try {
                await ultimateSync.signOutGoogle();
                log('âœ… Teste de logout Google concluÃ­do', 'success');
            } catch (error) {
                log(`âŒ Erro no teste de logout: ${error.message}`, 'error');
            }
        }

        function checkGoogleStatus() {
            log('ğŸ“Š Verificando status do Google Auth...', 'info');
            const status = ultimateSync.getStatus();
            
            log(`GAPI Carregado: ${!!window.gapi}`, 'info');
            log(`Auth2 DisponÃ­vel: ${status.googleAuthAvailable}`, 'info');
            log(`UsuÃ¡rio Logado: ${status.isGoogleSignedIn}`, 'info');
            
            if (window.gapi && window.gapi.auth2) {
                const authInstance = gapi.auth2.getAuthInstance();
                if (authInstance) {
                    const user = authInstance.currentUser.get();
                    log(`UsuÃ¡rio atual: ${user.isSignedIn() ? user.getBasicProfile().getName() : 'Nenhum'}`, 'info');
                }
            }
        }

        // Testes de SincronizaÃ§Ã£o por CÃ³digo
        function testGenerateCode() {
            log('ğŸ“¤ Gerando cÃ³digo de teste...', 'info');
            try {
                const code = ultimateSync.generateSyncCode();
                log(`âœ… CÃ³digo gerado: ${code}`, 'success');
                log('ğŸ’¡ Use este cÃ³digo em outro dispositivo para testar', 'info');
            } catch (error) {
                log(`âŒ Erro ao gerar cÃ³digo: ${error.message}`, 'error');
            }
        }

        async function testUseFakeCode() {
            log('ğŸ“¥ Testando cÃ³digo falso...', 'info');
            try {
                await ultimateSync.useSyncCode('000000');
                log('âŒ CÃ³digo falso foi aceito (erro!)', 'error');
            } catch (error) {
                log(`âœ… CÃ³digo falso rejeitado corretamente: ${error.message}`, 'success');
            }
        }

        function showSyncModal() {
            log('ğŸ”„ Abrindo modal de sincronizaÃ§Ã£o...', 'info');
            ultimateSync.showSyncModal();
        }

        function testCodeValidation() {
            log('âœ… Testando validaÃ§Ã£o de cÃ³digos...', 'info');
            
            const validCodes = ['123456', '000000', '999999'];
            const invalidCodes = ['12345', '1234567', 'abcdef', '', '12 34 56'];
            
            validCodes.forEach(code => {
                const isValid = /^\d{6}$/.test(code);
                log(`CÃ³digo ${code}: ${isValid ? 'âœ… VÃ¡lido' : 'âŒ InvÃ¡lido'}`, isValid ? 'success' : 'error');
            });
            
            invalidCodes.forEach(code => {
                const isValid = /^\d{6}$/.test(code);
                log(`CÃ³digo "${code}": ${isValid ? 'âŒ Incorretamente vÃ¡lido' : 'âœ… Corretamente invÃ¡lido'}`, isValid ? 'error' : 'success');
            });
        }

        // Testes de Dispositivo
        function testDeviceDetection() {
            log('ğŸ“± Testando detecÃ§Ã£o de dispositivo...', 'info');
            const status = ultimateSync.getStatus();
            
            log(`Device ID: ${status.deviceId}`, 'info');
            log(`Device Name: ${status.deviceName}`, 'info');
            log(`User Agent: ${navigator.userAgent}`, 'info');
            log(`Platform: ${navigator.platform}`, 'info');
            log(`Screen: ${screen.width}x${screen.height}`, 'info');
            log(`Mobile: ${/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}`, 'info');
        }

        function testLocalStorage() {
            log('ğŸ’¾ Testando LocalStorage...', 'info');
            
            try {
                const testKey = 'test_' + Date.now();
                const testValue = 'Ultimate Sync Test';
                
                localStorage.setItem(testKey, testValue);
                const retrieved = localStorage.getItem(testKey);
                localStorage.removeItem(testKey);
                
                if (retrieved === testValue) {
                    log('âœ… LocalStorage funcionando corretamente', 'success');
                } else {
                    log('âŒ LocalStorage nÃ£o retornou valor correto', 'error');
                }
            } catch (error) {
                log(`âŒ Erro no LocalStorage: ${error.message}`, 'error');
            }
        }

        function testCookies() {
            log('ğŸª Testando Cookies...', 'info');
            
            log(`Cookies habilitados: ${navigator.cookieEnabled}`, navigator.cookieEnabled ? 'success' : 'error');
            
            try {
                document.cookie = 'test=ultimate_sync_test; path=/';
                const cookieExists = document.cookie.includes('test=ultimate_sync_test');
                
                if (cookieExists) {
                    log('âœ… Cookies de primeira parte funcionando', 'success');
                    // Limpar cookie de teste
                    document.cookie = 'test=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                } else {
                    log('âŒ Cookies de primeira parte nÃ£o funcionando', 'error');
                }
            } catch (error) {
                log(`âŒ Erro ao testar cookies: ${error.message}`, 'error');
            }
        }

        function testBrowserFeatures() {
            log('ğŸŒ Testando recursos do navegador...', 'info');
            
            const features = {
                'Service Worker': 'serviceWorker' in navigator,
                'Push Notifications': 'PushManager' in window,
                'Geolocation': 'geolocation' in navigator,
                'Online/Offline': 'onLine' in navigator,
                'IndexedDB': 'indexedDB' in window,
                'WebGL': !!window.WebGLRenderingContext,
                'WebRTC': !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
                'Clipboard API': 'clipboard' in navigator
            };
            
            Object.entries(features).forEach(([feature, supported]) => {
                log(`${feature}: ${supported ? 'âœ… Suportado' : 'âŒ NÃ£o suportado'}`, supported ? 'success' : 'warning');
            });
        }

        // Testes de Erro
        function testNetworkError() {
            log('ğŸŒ Simulando erro de rede...', 'warning');
            
            // Simular cenÃ¡rio offline
            if (navigator.onLine) {
                log('ğŸ“¡ ConexÃ£o detectada - simulando offline', 'info');
                log('âš ï¸ Para testar offline real, desconecte a internet', 'warning');
            } else {
                log('ğŸ“´ Modo offline detectado', 'error');
            }
            
            // Testar Google APIs offline
            if (!window.gapi) {
                log('âŒ GAPI nÃ£o carregado (erro de rede simulado)', 'error');
            }
        }

        function testStorageError() {
            log('ğŸ’¾ Simulando erro de storage...', 'warning');
            
            try {
                // Tentar preencher localStorage
                let testData = '';
                for (let i = 0; i < 1000; i++) {
                    testData += 'Ultimate Sync Test Data ';
                }
                
                let counter = 0;
                try {
                    while (true) {
                        localStorage.setItem(`stress_test_${counter}`, testData);
                        counter++;
                        if (counter > 100) break; // Prevenir loop infinito
                    }
                } catch (e) {
                    log(`ğŸ’¾ Limite de storage atingido apÃ³s ${counter} entradas`, 'warning');
                    log(`Erro: ${e.message}`, 'error');
                }
                
                // Limpar dados de teste
                for (let i = 0; i < counter; i++) {
                    localStorage.removeItem(`stress_test_${i}`);
                }
                
            } catch (error) {
                log(`âŒ Erro de storage simulado: ${error.message}`, 'error');
            }
        }

        function testInvalidCode() {
            log('ğŸ”„ Testando cÃ³digos invÃ¡lidos...', 'info');
            
            const invalidCodes = ['', '123', '1234567', 'abcdef', '12 34 56', '000000'];
            
            invalidCodes.forEach(async (code) => {
                try {
                    await ultimateSync.useSyncCode(code);
                    log(`âŒ CÃ³digo invÃ¡lido "${code}" foi aceito incorretamente`, 'error');
                } catch (error) {
                    log(`âœ… CÃ³digo invÃ¡lido "${code}" rejeitado: ${error.message}`, 'success');
                }
            });
        }

        function testErrorRecovery() {
            log('ğŸ”§ Testando recuperaÃ§Ã£o de erros...', 'info');
            
            // Testar backup
            if (localStorage.getItem('backup_before_sync')) {
                log('âœ… Backup encontrado', 'success');
            } else {
                log('âš ï¸ Nenhum backup encontrado', 'warning');
            }
            
            // Testar limpeza de cÃ³digos expirados
            ultimateSync.cleanExpiredCodes();
            log('âœ… Limpeza de cÃ³digos expirados executada', 'success');
            
            // Testar reinicializaÃ§Ã£o
            try {
                ultimateSync.init();
                log('âœ… ReinicializaÃ§Ã£o bem-sucedida', 'success');
            } catch (error) {
                log(`âŒ Erro na reinicializaÃ§Ã£o: ${error.message}`, 'error');
            }
        }

        // UtilitÃ¡rios
        function clearLogs() {
            document.getElementById('logs').innerHTML = '<div class="log-entry log-info">ğŸ—‘ï¸ Logs limpos</div>';
            logCount = 1;
        }

        function exportLogs() {
            const logs = document.getElementById('logs').innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `ultimate_sync_logs_${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
            a.click();
            
            URL.revokeObjectURL(url);
            log('ğŸ“‹ Logs exportados', 'success');
        }

        function refreshStatus() {
            updateStatus();
            log('ğŸ”„ Status atualizado', 'info');
        }

        async function runFullDiagnostic() {
            log('ğŸ” Iniciando diagnÃ³stico completo...', 'info');
            
            // Esperar um pouco entre cada teste
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            
            testDeviceDetection();
            await delay(500);
            
            testBrowserFeatures();
            await delay(500);
            
            testLocalStorage();
            await delay(500);
            
            testCookies();
            await delay(500);
            
            checkGoogleStatus();
            await delay(500);
            
            testCodeValidation();
            await delay(500);
            
            log('âœ… DiagnÃ³stico completo finalizado', 'success');
            updateStatus();
        }

        // InicializaÃ§Ã£o
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ PÃ¡gina carregada, inicializando Ultimate Sync...', 'info');
            
            ultimateSync.init().then(() => {
                log('âœ… Ultimate Sync inicializado', 'success');
                updateStatus();
            }).catch(error => {
                log(`âŒ Erro na inicializaÃ§Ã£o: ${error.message}`, 'error');
                updateStatus();
            });
        });

        // Atualizar status periodicamente
        setInterval(updateStatus, 5000);

        // Se GAPI jÃ¡ estiver carregado
        if (window.gapi) {
            log('â„¹ï¸ GAPI jÃ¡ carregado', 'info');
            ultimateSync.init();
        }
    </script>
</body>
</html>