<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Google Auth - WYD Tracker</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: white;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        .status {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-family: monospace;
        }
        .success { border-left: 4px solid #2ecc71; }
        .error { border-left: 4px solid #e74c3c; }
        .info { border-left: 4px solid #3498db; }
        button {
            background: linear-gradient(135deg, #4285f4, #34a853);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico Google Auth</h1>
        <p>Teste de autentica√ß√£o para WYD Quest Tracker</p>
        
        <div id="environment" class="status info">
            <h3>üìç Ambiente Detectado</h3>
            <div id="envDetails"></div>
        </div>
        
        <div id="googleApi" class="status">
            <h3>üîß Google API</h3>
            <div id="apiStatus">Verificando...</div>
        </div>
        
        <div id="authStatus" class="status">
            <h3>üîê Status de Autentica√ß√£o</h3>
            <div id="authDetails">N√£o inicializado</div>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <button onclick="testGoogleAuth()">üß™ Testar Google Auth</button>
            <button onclick="showDebugInfo()">üêõ Info Debug</button>
            <button onclick="testClientId()">üîë Testar Client ID</button>
            <button onclick="testAlternativeAuth()">üîÑ M√©todo Alternativo</button>
        </div>
        
        <div id="logs" class="status" style="max-height: 300px; overflow-y: auto;">
            <h3>üìù Logs</h3>
            <div id="logContent"></div>
        </div>
    </div>

    <script>
        const CLIENT_ID = '507473876859-o0urtsgjnetchqkqcf16ium53ejp1tts.apps.googleusercontent.com';
        let gauth = null;
        
        function log(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logEntry.style.color = type === 'error' ? '#e74c3c' : type === 'success' ? '#2ecc71' : '#ecf0f1';
            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function updateEnvironment() {
            const envDetails = document.getElementById('envDetails');
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const port = window.location.port;
            const url = window.location.href;
            
            const isHTTPS = protocol === 'https:';
            const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';
            const isGitHubPages = hostname === 'luizcborba.github.io';
            
            envDetails.innerHTML = `
                <strong>URL:</strong> ${url}<br>
                <strong>Protocol:</strong> ${protocol} ${isHTTPS ? '‚úÖ' : '‚ùå'}<br>
                <strong>Hostname:</strong> ${hostname}<br>
                <strong>Port:</strong> ${port || 'padr√£o'}<br>
                <strong>Localhost:</strong> ${isLocalhost ? '‚úÖ' : '‚ùå'}<br>
                <strong>GitHub Pages:</strong> ${isGitHubPages ? '‚úÖ' : '‚ùå'}<br>
                <strong>Google Auth Compatible:</strong> ${(isHTTPS && isGitHubPages) || isLocalhost ? '‚úÖ' : '‚ùå'}
            `;
            
            log(`Ambiente: ${protocol}//${hostname}${port ? ':'+port : ''}`);
            log(`HTTPS: ${isHTTPS}, Localhost: ${isLocalhost}, GitHub Pages: ${isGitHubPages}`);
        }
        
        function loadGoogleAPI() {
            return new Promise((resolve, reject) => {
                if (window.gapi) {
                    resolve();
                    return;
                }
                
                log('Carregando Google API...');
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js';
                script.onload = () => {
                    log('Google API carregada ‚úÖ', 'success');
                    resolve();
                };
                script.onerror = () => {
                    log('Erro ao carregar Google API ‚ùå', 'error');
                    reject(new Error('Falha ao carregar Google API'));
                };
                document.head.appendChild(script);
            });
        }
        
        async function testGoogleAuth() {
            const apiStatus = document.getElementById('apiStatus');
            const authDetails = document.getElementById('authDetails');
            
            try {
                log('Iniciando teste de Google Auth...');
                
                // 1. Carregar Google API
                await loadGoogleAPI();
                apiStatus.innerHTML = '‚úÖ Google API carregada';
                apiStatus.parentElement.className = 'status success';
                
                // 2. Inicializar Auth2
                await new Promise((resolve, reject) => {
                    gapi.load('auth2', async () => {
                        try {
                            log('Inicializando Google Auth2...');
                            log(`Client ID: ${CLIENT_ID}`);
                            log(`URL atual: ${window.location.href}`);
                            
                            // Verificar se j√° existe uma inst√¢ncia
                            if (gapi.auth2.getAuthInstance()) {
                                log('Inst√¢ncia Auth2 j√° existe, usando existente...');
                                gauth = gapi.auth2.getAuthInstance();
                            } else {
                                log('Criando nova inst√¢ncia Auth2...');
                                gauth = await gapi.auth2.init({
                                    client_id: CLIENT_ID,
                                    scope: 'profile email',
                                    fetch_basic_profile: true,
                                    ux_mode: 'popup'
                                });
                            }
                            
                            log('Google Auth2 inicializado ‚úÖ', 'success');
                            authDetails.innerHTML = '‚úÖ Google Auth inicializado';
                            authDetails.parentElement.className = 'status success';
                            
                            // 3. Verificar status de login
                            const isSignedIn = gauth.isSignedIn.get();
                            log(`Status login: ${isSignedIn ? 'Logado' : 'N√£o logado'}`);
                            
                            if (isSignedIn) {
                                const user = gauth.currentUser.get();
                                const profile = user.getBasicProfile();
                                authDetails.innerHTML += `<br>üë§ ${profile.getName()} (${profile.getEmail()})`;
                            }
                            
                            resolve();
                        } catch (error) {
                            log(`Erro ao inicializar Auth2: ${error}`, 'error');
                            log(`Tipo do erro: ${typeof error}`, 'error');
                            log(`Error.message: ${error?.message || 'N/A'}`, 'error');
                            log(`Error.details: ${error?.details || 'N/A'}`, 'error');
                            log(`Error.error: ${error?.error || 'N/A'}`, 'error');
                            log(`Error completo: ${JSON.stringify(error, null, 2)}`, 'error');
                            
                            // Verificar poss√≠veis problemas
                            if (error && error.error === 'idpiframe_initialization_failed') {
                                log('DIAGN√ìSTICO: Problema com iframe do Google - poss√≠vel bloqueio de cookies', 'error');
                            } else if (error && error.error === 'popup_closed_by_user') {
                                log('DIAGN√ìSTICO: Popup fechado pelo usu√°rio', 'error');
                            } else if (!error || error === undefined) {
                                log('DIAGN√ìSTICO: Erro undefined - poss√≠vel problema de configura√ß√£o no Google Console', 'error');
                                log('Verifique: 1) Client ID correto, 2) Domain autorizado, 3) Redirect URIs', 'error');
                            }
                            
                            authDetails.innerHTML = `‚ùå Erro: ${error?.message || error?.error || 'undefined - verifique configura√ß√£o Google Console'}`;
                            authDetails.parentElement.className = 'status error';
                            reject(error);
                        }
                    });
                });
                
                // 4. Tentar login
                log('Tentando login...');
                const user = await gauth.signIn();
                const profile = user.getBasicProfile();
                
                log(`Login realizado ‚úÖ: ${profile.getName()}`, 'success');
                authDetails.innerHTML = `‚úÖ Login realizado!<br>üë§ ${profile.getName()}<br>üìß ${profile.getEmail()}`;
                
            } catch (error) {
                log(`Erro no teste: ${error.message}`, 'error');
                
                if (error.error === 'popup_blocked_by_browser') {
                    authDetails.innerHTML = '‚ùå Popup bloqueado pelo navegador';
                } else if (error.error === 'access_denied') {
                    authDetails.innerHTML = '‚ùå Acesso negado pelo usu√°rio';
                } else if (error.error === 'redirect_uri_mismatch') {
                    authDetails.innerHTML = '‚ùå Erro de redirect_uri - verifique configura√ß√£o no Google Console';
                } else {
                    authDetails.innerHTML = `‚ùå Erro: ${error.message || error.error || 'Desconhecido'}`;
                }
                
                authDetails.parentElement.className = 'status error';
            }
        }
        
        function showDebugInfo() {
            log('=== DEBUG INFO ===');
            log(`Client ID: ${CLIENT_ID}`);
            log(`Client ID length: ${CLIENT_ID.length}`);
            log(`Client ID v√°lido: ${CLIENT_ID.endsWith('.apps.googleusercontent.com') ? 'SIM' : 'N√ÉO'}`);
            log(`User Agent: ${navigator.userAgent}`);
            log(`Cookies habilitados: ${navigator.cookieEnabled}`);
            log(`Local Storage: ${typeof(Storage) !== "undefined" ? 'Dispon√≠vel' : 'N√£o dispon√≠vel'}`);
            log(`Referrer: ${document.referrer || 'Nenhum'}`);
            log(`Third-party cookies: ${document.cookie ? 'Permitidos' : 'Bloqueados/Vazios'}`);
            
            // Testar URLs esperadas
            const expectedURLs = [
                'https://luizcborba.github.io/TrackerMobile/',
                'http://localhost:8080',
                'http://127.0.0.1:8080'
            ];
            
            log('URLs configuradas esperadas:');
            expectedURLs.forEach(url => {
                log(`  - ${url}`);
            });
            
            log(`URL atual: ${window.location.href}`);
            
            // Verificar dom√≠nio autorizado
            const currentDomain = `${window.location.protocol}//${window.location.hostname}${window.location.port ? ':' + window.location.port : ''}`;
            log(`Dom√≠nio atual: ${currentDomain}`);
            
            // Verificar se gapi est√° carregado
            log(`GAPI carregado: ${typeof gapi !== 'undefined' ? 'SIM' : 'N√ÉO'}`);
            if (typeof gapi !== 'undefined') {
                log(`GAPI auth2 dispon√≠vel: ${typeof gapi.auth2 !== 'undefined' ? 'SIM' : 'N√ÉO'}`);
            }
        }
        
        function testClientId() {
            log('=== TESTE CLIENT ID ===');
            log(`Client ID: ${CLIENT_ID}`);
            
            // Verifica√ß√µes b√°sicas
            const validFormat = CLIENT_ID.match(/^\d+-[a-z0-9]+\.apps\.googleusercontent\.com$/);
            log(`Formato v√°lido: ${validFormat ? 'SIM ‚úÖ' : 'N√ÉO ‚ùå'}`);
            
            const correctLength = CLIENT_ID.length > 50 && CLIENT_ID.length < 100;
            log(`Tamanho adequado: ${correctLength ? 'SIM ‚úÖ' : 'N√ÉO ‚ùå'}`);
            
            // Teste de conectividade com Google
            log('Testando conectividade com Google APIs...');
            fetch('https://accounts.google.com/.well-known/openid_configuration')
                .then(response => {
                    if (response.ok) {
                        log('Conectividade Google: OK ‚úÖ', 'success');
                    } else {
                        log('Conectividade Google: ERRO ‚ùå', 'error');
                    }
                })
                .catch(error => {
                    log(`Conectividade Google: ERRO ‚ùå - ${error.message}`, 'error');
                });
        }
        
        function testAlternativeAuth() {
            log('=== M√âTODO ALTERNATIVO ===');
            
            // Tentar com configura√ß√£o mais espec√≠fica
            loadGoogleAPI().then(() => {
                gapi.load('auth2', () => {
                    log('Tentando inicializa√ß√£o com configura√ß√£o alternativa...');
                    
                    const authInstance = gapi.auth2.init({
                        client_id: CLIENT_ID,
                        scope: 'openid profile email',
                        fetch_basic_profile: true,
                        ux_mode: 'popup',
                        hosted_domain: undefined,
                        plugin_name: 'WYD_Quest_Tracker'
                    });
                    
                    authInstance.then(
                        (auth) => {
                            log('Auth alternativo inicializado ‚úÖ', 'success');
                            log(`Usu√°rio logado: ${auth.isSignedIn.get()}`);
                            
                            if (!auth.isSignedIn.get()) {
                                log('Tentando login...');
                                auth.signIn().then(
                                    (user) => {
                                        const profile = user.getBasicProfile();
                                        log(`Login sucesso ‚úÖ: ${profile.getName()}`, 'success');
                                    },
                                    (error) => {
                                        log(`Login falhou ‚ùå: ${error.error || error}`, 'error');
                                    }
                                );
                            }
                        },
                        (error) => {
                            log(`Auth alternativo falhou ‚ùå: ${error.error || error}`, 'error');
                            log(`Detalhes: ${JSON.stringify(error, null, 2)}`);
                        }
                    );
                });
            });
        }
        
        // Inicializar
        updateEnvironment();
    </script>
</body>
</html>